From 70413a0815bd158555632c5ea45f4a356d0d7e38 Mon Sep 17 00:00:00 2001
From: lizhirong <zhirong.li@spacemit.com>
Date: Thu, 26 Dec 2024 16:46:24 +0800
Subject: [PATCH 1416/1448] camera:ccic: fix deadlock problem of ccic_test in
 mlx75027

Change-Id: I11d1669c0e016fd855a5ed1d38da675c05cdd3be
---
 .../platform/spacemit/camera/cam_ccic/ccic_drv.c    | 13 +++++++++----
 1 file changed, 9 insertions(+), 4 deletions(-)

diff --git a/drivers/media/platform/spacemit/camera/cam_ccic/ccic_drv.c b/drivers/media/platform/spacemit/camera/cam_ccic/ccic_drv.c
index 23196686257a..1e68952f092c 100644
--- a/drivers/media/platform/spacemit/camera/cam_ccic/ccic_drv.c
+++ b/drivers/media/platform/spacemit/camera/cam_ccic/ccic_drv.c
@@ -937,7 +937,8 @@ static void ccic_dma_bh_handler(struct ccic_dma_work_struct *ccic_dma_work)
 	LIST_HEAD(export_list);
 	unsigned long flags = 0;
 
-	spin_lock(&ac_vnode->waitq_head.lock);
+	//spin_lock(&ac_vnode->waitq_head.lock);
+	spin_lock_irqsave(&ac_vnode->waitq_head.lock, flags);
 	ac_vnode->in_tasklet = 1;
 	if (ac_vnode->in_streamoff || !ac_vnode->is_streaming) {
 		wake_up_locked(&ac_vnode->waitq_head);
@@ -945,7 +946,9 @@ static void ccic_dma_bh_handler(struct ccic_dma_work_struct *ccic_dma_work)
 		goto dma_tasklet_finish;
 	}
 	wake_up_locked(&ac_vnode->waitq_head);
-	spin_unlock(&ac_vnode->waitq_head.lock);
+//	spin_unlock(&ac_vnode->waitq_head.lock);
+	spin_unlock_irqrestore(&ac_vnode->waitq_head.lock, flags);
+
 	spin_lock_irqsave(&ac_vnode->slock, flags);
 	list_for_each_entry_safe(pos, n, &ac_vnode->busy_list, list_entry) {
 		if (pos->flags & (AC_BUF_FLAG_HW_ERR | AC_BUF_FLAG_SW_ERR | AC_BUF_FLAG_DONE_TOUCH)) {
@@ -976,10 +979,12 @@ static void ccic_dma_bh_handler(struct ccic_dma_work_struct *ccic_dma_work)
 	}
 dma_tasklet_finish:
 	if (ac_vnode) {
-		spin_lock(&ac_vnode->waitq_head.lock);
+		spin_lock_irqsave(&ac_vnode->waitq_head.lock, flags);
+		//spin_lock(&ac_vnode->waitq_head.lock);
 		ac_vnode->in_tasklet = 0;
 		wake_up_locked(&ac_vnode->waitq_head);
-		spin_unlock(&ac_vnode->waitq_head.lock);
+		//spin_unlock(&ac_vnode->waitq_head.lock);
+		spin_unlock_irqrestore(&ac_vnode->waitq_head.lock, flags);
 	}
 	ccic_put_dma_work(dma_ctx, ccic_dma_work);
 }
-- 
2.47.0

