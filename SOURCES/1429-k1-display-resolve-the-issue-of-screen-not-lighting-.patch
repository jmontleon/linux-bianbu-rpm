From 0575b0e039a5c9b01137c349985da722f5ec47b2 Mon Sep 17 00:00:00 2001
From: zhenglilang <lilang.zheng@spacemit.com>
Date: Thu, 9 Jan 2025 16:51:59 +0800
Subject: [PATCH 1429/1448] k1:display: resolve the issue of screen not
 lighting up due to inappropriate power-on timing

Change-Id: Ifbc8a16232407b868c4e07d5ecce9648873ba10b
---
 arch/riscv/boot/dts/spacemit/k1-x_MUSE-Book.dts |  4 ++--
 drivers/gpu/drm/spacemit/lt8911exb.c            | 15 +++++++--------
 2 files changed, 9 insertions(+), 10 deletions(-)

diff --git a/arch/riscv/boot/dts/spacemit/k1-x_MUSE-Book.dts b/arch/riscv/boot/dts/spacemit/k1-x_MUSE-Book.dts
index 5ca42f0d33ce..1668ef596300 100644
--- a/arch/riscv/boot/dts/spacemit/k1-x_MUSE-Book.dts
+++ b/arch/riscv/boot/dts/spacemit/k1-x_MUSE-Book.dts
@@ -201,7 +201,6 @@ &dpu_online2_dsi {
 	spacemit-dpu-bitclk = <933000000>;
 	dsi_1v2-supply = <&ldo_5>;
 	vin-supply-names = "dsi_1v2";
-	enable-gpio = <&gpio 75 0>;
 	status = "okay";
 };
 
@@ -326,7 +325,8 @@ lt8911exb_i2c@29 {
 		reg = <0x29>;
 
 		reset-gpio = <&gpio 114 0>;
-		bl-gpio = <&gpio 83 0>;
+		bl-gpio = <&gpio 75 0>;
+		enable-gpio = <&gpio 83 0>;
 		standby-gpio = <&gpio 92 0>;
 
 		status = "okay";
diff --git a/drivers/gpu/drm/spacemit/lt8911exb.c b/drivers/gpu/drm/spacemit/lt8911exb.c
index 20b596d0e383..bf93c33669c8 100644
--- a/drivers/gpu/drm/spacemit/lt8911exb.c
+++ b/drivers/gpu/drm/spacemit/lt8911exb.c
@@ -991,11 +991,11 @@ void lt8911exb_reset(struct lt8911exb *lt8911exb)
 	}
 
 	gpiod_direction_output(lt8911exb->reset_gpio, 1);
-	usleep_range(5*1000, 10*1000); //10ms
+	usleep_range(5*1000, 10*1000);
 	gpiod_direction_output(lt8911exb->reset_gpio, 0);
-	usleep_range(5*1000, 10*1000); //10ms
+	usleep_range(40*1000, 50*1000);
 	gpiod_direction_output(lt8911exb->reset_gpio, 1);
-	usleep_range(5*1000, 10*1000); //10ms
+	usleep_range(40*1000, 50*1000);
 }
 
 void LT8911EX_TxSwingPreSet(struct lt8911exb *lt8911exb)
@@ -1057,7 +1057,7 @@ void LT8911EXB_LinkTrainResultCheck( struct lt8911exb *lt8911exb)
 			mdelay(10); // return;
 		} else {
 			//DRM_DEBUG_ATOMIC("\r\nLT8911_LinkTrainResultCheck: link trian on going...");
-			mdelay(10);
+			mdelay(20);
 		}
 	}
 #endif
@@ -1152,7 +1152,9 @@ static int lt8911exb_panel_enable(struct drm_panel *panel)
 	struct lt8911exb *lt8911exb = panel_to_lt8911exb(panel);
 
 	DRM_INFO("%s()\n", __func__);
-
+	if (!IS_ERR_OR_NULL(lt8911exb->enable_gpio)) {
+		gpiod_direction_output(lt8911exb->enable_gpio, 1);
+	}
 	schedule_delayed_work(&lt8911exb->init_work,
 				msecs_to_jiffies(100));
 	lt8911exb->init_work_pending = true;
@@ -1265,9 +1267,6 @@ static void init_work_func(struct work_struct *work)
 	mdelay(80);
 	PCR_Status(lt8911exb);
 
-	if (!IS_ERR_OR_NULL(lt8911exb->enable_gpio)) {
-		gpiod_direction_output(lt8911exb->enable_gpio, 1);
-	}
 	gpiod_direction_output(lt8911exb->bl_gpio, 1);
 }
 static int lt8911exb_probe(struct i2c_client *client)
-- 
2.47.0

