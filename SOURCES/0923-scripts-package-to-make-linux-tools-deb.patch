From 4c2f156ba8bd7ea7b5fce98ca75f677ca7fdd331 Mon Sep 17 00:00:00 2001
From: liweizhi <weizhi.li@spacemit.com>
Date: Mon, 15 Jul 2024 09:55:00 +0800
Subject: [PATCH 0923/1448] scripts/package to make linux-tools deb

* Now only the perf command is included

Change-Id: Icc8f1ea3d7073ba9d6e54190f0e2cc123cb4a2e1
---
 scripts/package/builddeb     | 36 ++++++++++++++++++++++++++++++++++++
 scripts/package/debian/rules | 18 +++++++++++++++++-
 scripts/package/generic      | 16 ++++++++++++++++
 scripts/package/mkdebian     | 20 ++++++++++++++++++++
 4 files changed, 89 insertions(+), 1 deletion(-)
 create mode 100644 scripts/package/generic

diff --git a/scripts/package/builddeb b/scripts/package/builddeb
index d7dd0d04c70c..e1c3a9e696cd 100755
--- a/scripts/package/builddeb
+++ b/scripts/package/builddeb
@@ -182,6 +182,34 @@ install_libc_headers () {
 	mv $pdir/usr/include/asm $pdir/usr/include/$host_arch/
 }
 
+install_tools(){
+	pdir=$1
+	version=$2
+
+	rm -rf $pdir
+
+	mkdir -p "$pdir/usr/lib/linux-tools/$version"
+	install -m755 $srctree/tools/perf/perf $pdir/usr/lib/linux-tools/$version
+}
+
+install_tools_common(){
+	pdir=$1
+
+	rm -rf $pdir
+
+	toolsbin=$pdir/usr/bin
+	toolssbin=$pdir/usr/sbin
+	toolsman=$pdir/usr/share/man
+
+	install -d $toolsbin
+	install -d $toolssbin
+	install -d $toolsman/man1
+	install -d $toolsman/man8
+
+	install -m755 $srctree/scripts/package/generic $toolsbin/perf
+	install -m644 $srctree/tools/perf/Documentation/*.1 $toolsman/man1
+}
+
 rm -f debian/files
 
 packages_enabled=$(dh_listpackages)
@@ -199,6 +227,10 @@ do
 		install_libc_headers debian/linux-libc-dev;;
 	linux-headers-*)
 		install_kernel_headers debian/linux-headers ${package#linux-headers-};;
+	linux-tools-common)
+		install_tools_common debian/linux-tools-common;;
+	linux-tools-*)
+		install_tools debian/linux-tools ${package#linux-tools-};;
 	esac
 done
 
@@ -213,6 +245,10 @@ do
 		create_package ${package} debian/linux-libc-dev;;
 	linux-headers-*)
 		create_package ${package} debian/linux-headers;;
+	linux-tools-common)
+		create_package ${package} debian/linux-tools-common;;
+	linux-tools-*)
+		create_package ${package} debian/linux-tools;;
 	esac
 done
 
diff --git a/scripts/package/debian/rules b/scripts/package/debian/rules
index 3dafa9496c63..d821b6f57037 100755
--- a/scripts/package/debian/rules
+++ b/scripts/package/debian/rules
@@ -3,13 +3,24 @@
 
 include debian/rules.vars
 
-srctree ?= .
+srctree = $(abs_srctree)
 
 ifneq (,$(filter-out parallel=1,$(filter parallel=%,$(DEB_BUILD_OPTIONS))))
     NUMJOBS = $(patsubst parallel=%,%,$(filter parallel=%,$(DEB_BUILD_OPTIONS)))
     MAKEFLAGS += -j$(NUMJOBS)
 endif
 
+PERF_BUILD_OPTS := prefix=/usr HAVE_NO_LIBBFD=1 HAVE_CPLUS_DEMANGLE_SUPPORT=1 CROSS_COMPILE=$(CROSS_COMPILE) NO_LIBPYTHON=1 NO_LIBPERL=1 WERROR=0
+
+# Conditional flags based on whether it's a cross-compile
+ifeq ("$(DEB_BUILD_GNU_TYPE)", "$(DEB_HOST_GNU_TYPE)")
+    # Building for the host
+    ADDITIONAL_OPTS :=
+else
+    # Cross-compiling
+    ADDITIONAL_OPTS := NO_LIBELF=1 NO_LIBTRACEEVENT=1
+endif
+
 .PHONY: binary binary-indep binary-arch
 binary: binary-arch binary-indep
 binary-indep: build-indep
@@ -26,8 +37,13 @@ build-arch:
 	KERNELRELEASE=$(KERNELRELEASE) \
 	$(shell $(srctree)/scripts/package/deb-build-option) \
 	olddefconfig all
+	# perf
+	cd $(srctree)/tools/perf && $(MAKE) $(PERF_BUILD_OPTS) $(ADDITIONAL_OPTS)
+	cd $(srctree)/tools/perf && $(MAKE) $(PERF_BUILD_OPTS) $(ADDITIONAL_OPTS) man
 
 .PHONY: clean
 clean:
 	rm -rf debian/files debian/linux-*
 	$(MAKE) -f $(srctree)/Makefile ARCH=$(ARCH) clean
+	# perf
+	cd $(srctree)/tools/perf && $(MAKE) clean
\ No newline at end of file
diff --git a/scripts/package/generic b/scripts/package/generic
new file mode 100644
index 000000000000..3b0286cd0e5a
--- /dev/null
+++ b/scripts/package/generic
@@ -0,0 +1,16 @@
+#!/bin/bash
+full_version=`uname -r`
+
+# First check for a fully qualified version.
+this="/usr/lib/linux-tools/$full_version/`basename $0`"
+if [ -f "$this" ]; then
+	exec "$this" "$@"
+fi
+
+# Give them a hint as to what to install.
+echo "WARNING: `basename $0` not found for kernel $full_version" >&2
+echo "" >&2
+echo "  You may need to install the following packages for this specific kernel:" >&2
+echo "    linux-tools-$full_version" >&2
+
+exit 2
\ No newline at end of file
diff --git a/scripts/package/mkdebian b/scripts/package/mkdebian
index e1cb07c76fb8..085270775ea6 100755
--- a/scripts/package/mkdebian
+++ b/scripts/package/mkdebian
@@ -237,6 +237,26 @@ Description: Linux support headers for userspace development
  This package provides userspaces headers from the Linux kernel.  These headers
  are used by the installed headers for GNU glibc and other system libraries.
 Multi-Arch: same
+
+Package: linux-tools-$version
+Architecture: $debarch
+Section: devel
+Depends: linux-tools-common
+Description: Linux kernel version specific tools for version -$version
+ This package provides the architecture dependant parts for kernel
+ version locked tools (such as perf) for
+ version -$version on
+ .
+
+Package: linux-tools-common
+Architecture: all
+Multi-Arch: foreign
+Section: kernel
+Depends: lsb-release
+Description: Linux kernel version specific tools for version $version
+ This package provides the architecture independent parts for kernel
+ version locked tools (such as perf) for
+ version $version.
 EOF
 
 if is_enabled CONFIG_MODULES; then
-- 
2.47.0

