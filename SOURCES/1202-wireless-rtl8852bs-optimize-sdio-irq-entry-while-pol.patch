From 4dae6b9ff5b298daa61067436131ac240d0e770a Mon Sep 17 00:00:00 2001
From: wanlong <long.wan@spacemit.com>
Date: Thu, 24 Oct 2024 14:59:45 +0800
Subject: [PATCH 1202/1451] wireless: rtl8852bs: optimize sdio irq entry while
 poll register

Change-Id: If3bc76cfceb56ed62d19e2a78f3bc59777708a36
---
 .../rtl8852bs/phl/hal_g6/mac/mac_ax/_sdio.c       | 15 +++++++++++++++
 .../phl/hal_g6/mac/mac_ax/mac_8852b/_sdio_8852b.c |  5 +++++
 2 files changed, 20 insertions(+)

diff --git a/drivers/net/wireless/realtek/rtl8852bs/phl/hal_g6/mac/mac_ax/_sdio.c b/drivers/net/wireless/realtek/rtl8852bs/phl/hal_g6/mac/mac_ax/_sdio.c
index e28a85820bc0..7f4dd9d4c98a 100644
--- a/drivers/net/wireless/realtek/rtl8852bs/phl/hal_g6/mac/mac_ax/_sdio.c
+++ b/drivers/net/wireless/realtek/rtl8852bs/phl/hal_g6/mac/mac_ax/_sdio.c
@@ -593,6 +593,11 @@ u32 r_indir_cmd53_sdio(struct mac_ax_adapter *adapter, u32 adr)
 		PLTFM_MSG_ERR("[ERR]addr 0x%x = 0xdeadbeef\n", dw_adr);
 		PLTFM_SDIO_CMD53_W32(R_AX_CK_EN, CMAC_CLK_ALLEN);
 		count++;
+		if (num_online_cpus() == 1)
+			rtw_msleep_os(5);
+		else {
+			rtw_usleep_os(200);
+		}
 	}
 
 	return (dw >> dw_sh);
@@ -792,6 +797,11 @@ u32 tx_allow_data_ch(struct mac_ax_adapter *adapter,
 			pub_info->wp_aval -= info->ple_rqd_num;
 			break;
 		}
+		if (num_online_cpus() == 1)
+			rtw_msleep_os(5);
+		else {
+			rtw_usleep_os(200);
+		}
 		p_ops->ud_fs(adapter);
 		cnt--;
 	} while (cnt);
@@ -817,6 +827,11 @@ u32 tx_allow_fwcmd_ch(struct mac_ax_adapter *adapter,
 			ch_info[MAC_AX_DMA_H2C].aval -= info->ple_rqd_num;
 			break;
 		}
+		if (num_online_cpus() == 1)
+			rtw_msleep_os(5);
+		else {
+			rtw_usleep_os(200);
+		}
 		p_ops->ud_fs(adapter);
 		cnt--;
 	} while (cnt);
diff --git a/drivers/net/wireless/realtek/rtl8852bs/phl/hal_g6/mac/mac_ax/mac_8852b/_sdio_8852b.c b/drivers/net/wireless/realtek/rtl8852bs/phl/hal_g6/mac/mac_ax/mac_8852b/_sdio_8852b.c
index 17ac26e7204b..44d127b51f79 100644
--- a/drivers/net/wireless/realtek/rtl8852bs/phl/hal_g6/mac/mac_ax/mac_8852b/_sdio_8852b.c
+++ b/drivers/net/wireless/realtek/rtl8852bs/phl/hal_g6/mac/mac_ax/mac_8852b/_sdio_8852b.c
@@ -231,6 +231,11 @@ u8 r_indir_cmd52_sdio_8852b(struct mac_ax_adapter *adapter, u32 adr)
 		PLTFM_SDIO_CMD52_W8(R_AX_CK_EN + 3, (u8)(val >> 24));
 
 		count++;
+		if (num_online_cpus() == 1)
+			rtw_msleep_os(5);
+		else {
+			rtw_usleep_os(200);
+		}
 	}
 
 	return val32.byte[dw_sh];
-- 
2.47.0

