From 48358e81fd48a909884daa55b9d6bb09d680eb27 Mon Sep 17 00:00:00 2001
From: Nell <xianbin.zhu@spacemit.com>
Date: Tue, 29 Oct 2024 16:22:11 +0800
Subject: [PATCH 1343/1448] k1:watchdog: support suspend to disk

Change-Id: I1ea9cbcc48dd8ac94f595956f847b66a8c15124a
---
 drivers/watchdog/k1x_wdt.c | 20 ++++++++++++--------
 1 file changed, 12 insertions(+), 8 deletions(-)

diff --git a/drivers/watchdog/k1x_wdt.c b/drivers/watchdog/k1x_wdt.c
index 67195e5971cb..a9da4b3ddc93 100644
--- a/drivers/watchdog/k1x_wdt.c
+++ b/drivers/watchdog/k1x_wdt.c
@@ -26,6 +26,7 @@
 #include <linux/hrtimer.h>
 #include <asm/cacheflush.h>
 
+#include <linux/pm.h>
 #include <linux/of.h>
 #include <linux/of_address.h>
 #include <linux/of_device.h>
@@ -762,9 +763,9 @@ static void spa_wdt_shutdown(struct platform_device *pdev)
 }
 
 #ifdef CONFIG_PM
-static int spa_wdt_suspend(struct platform_device *pdev, pm_message_t state)
+static int spa_wdt_suspend(struct device *dev)
 {
-	struct spa_wdt_info *info = platform_get_drvdata(pdev);
+	struct spa_wdt_info *info = dev_get_drvdata(dev);
 
 	if (info->ctrl) {
 		/* turn watchdog off */
@@ -782,9 +783,9 @@ static int spa_wdt_suspend(struct platform_device *pdev, pm_message_t state)
 	return 0;
 }
 
-static int spa_wdt_resume(struct platform_device *pdev)
+static int spa_wdt_resume(struct device *dev)
 {
-	struct spa_wdt_info *info = platform_get_drvdata(pdev);
+	struct spa_wdt_info *info = dev_get_drvdata(dev);
 
 	if (info->ctrl) {
 		spa_wdt_start(&info->wdt_dev);
@@ -801,9 +802,11 @@ static int spa_wdt_resume(struct platform_device *pdev)
 	return 0;
 }
 
+static const struct dev_pm_ops wdt_pm_ops = {
+	SET_SYSTEM_SLEEP_PM_OPS(spa_wdt_suspend, spa_wdt_resume)
+};
 #else
-#define spa_wdt_suspend NULL
-#define spa_wdt_resume  NULL
+#define &wdt_pm_ops NULL
 #endif /* CONFIG_PM */
 
 #ifdef CONFIG_OF_RESERVED_MEM
@@ -836,10 +839,11 @@ static struct platform_driver spa_wdt_driver = {
 	.probe		= spa_wdt_probe,
 	.remove		= spa_wdt_remove,
 	.shutdown	= spa_wdt_shutdown,
-	.suspend	= spa_wdt_suspend,
-	.resume		= spa_wdt_resume,
 	.driver		= {
 		.name	= "spa-wdt",
+#ifdef CONFIG_PM
+		.pm = &wdt_pm_ops,
+#endif
 		.of_match_table	= of_match_ptr(spa_wdt_match),
 	},
 };
-- 
2.47.0

