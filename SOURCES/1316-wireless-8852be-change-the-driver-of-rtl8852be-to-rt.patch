From a6f45063e5d150ff3c2bc9c0647fef48255f96ca Mon Sep 17 00:00:00 2001
From: huzhen <george.hu@spacemit.com>
Date: Thu, 28 Nov 2024 10:20:25 +0800
Subject: [PATCH 1316/1448] wireless:8852be: change the driver of rtl8852be to
 rtw89

	adding the switch of rtl8852be radio

Change-Id: Ia05e42f5a7542f1309c3f6fcc1ab370a96ed83e5
---
 arch/riscv/configs/k1_defconfig                |  4 +++-
 drivers/net/wireless/realtek/rtw89/rtw8852be.c | 17 +++++++++++++++++
 2 files changed, 20 insertions(+), 1 deletion(-)

diff --git a/arch/riscv/configs/k1_defconfig b/arch/riscv/configs/k1_defconfig
index 34654f492ef4..3804f1ade26d 100644
--- a/arch/riscv/configs/k1_defconfig
+++ b/arch/riscv/configs/k1_defconfig
@@ -489,6 +489,7 @@ CONFIG_BT_HCIUART_RTL=y
 CONFIG_AF_KCM=m
 CONFIG_MCTP=y
 CONFIG_CFG80211=y
+CONFIG_MAC80211=y
 CONFIG_RFKILL=y
 CONFIG_NET_IFE=m
 CONFIG_PCI=y
@@ -661,8 +662,9 @@ CONFIG_USB_NET_ASIX=m
 # CONFIG_WLAN_VENDOR_MICROCHIP is not set
 # CONFIG_WLAN_VENDOR_PURELIFI is not set
 # CONFIG_WLAN_VENDOR_RALINK is not set
+CONFIG_RTW89=y
+CONFIG_RTW89_8852BE=m
 CONFIG_RTL8852BS=m
-CONFIG_RTL8852BE=m
 # CONFIG_WLAN_VENDOR_RSI is not set
 # CONFIG_WLAN_VENDOR_SILABS is not set
 # CONFIG_WLAN_VENDOR_ST is not set
diff --git a/drivers/net/wireless/realtek/rtw89/rtw8852be.c b/drivers/net/wireless/realtek/rtw89/rtw8852be.c
index ecf39d2d9f81..efec0df06549 100644
--- a/drivers/net/wireless/realtek/rtw89/rtw8852be.c
+++ b/drivers/net/wireless/realtek/rtw89/rtw8852be.c
@@ -83,7 +83,24 @@ static struct pci_driver rtw89_8852be_driver = {
 	.remove		= rtw89_pci_remove,
 	.driver.pm	= &rtw89_pm_ops,
 };
+
+#if defined(CONFIG_SOC_SPACEMIT_K1X)
+extern int spacemit_wlan_set_power(int on);
+static int __init rtw89_8852be_driver_init(void)
+{
+	spacemit_wlan_set_power(1);
+	return pci_register_driver(&rtw89_8852be_driver);
+}
+module_init(rtw89_8852be_driver_init);
+static void __exit rtw89_8852be_driver_exit(void)
+{
+	pci_unregister_driver(&rtw89_8852be_driver);
+	spacemit_wlan_set_power(0);
+}
+module_exit(rtw89_8852be_driver_exit);
+#elif
 module_pci_driver(rtw89_8852be_driver);
+#endif
 
 MODULE_AUTHOR("Realtek Corporation");
 MODULE_DESCRIPTION("Realtek 802.11ax wireless 8852BE driver");
-- 
2.47.0

