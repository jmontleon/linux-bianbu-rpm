From 2dd5be03b482bda3c3990d6340d8fb32c99433ea Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?=E2=80=9Cweijinmei=E2=80=9D?= <jinmei.wei@spacemit.com>
Date: Tue, 26 Mar 2024 15:28:56 +0800
Subject: [PATCH 0736/1448] aud: fix codec es8326 pop noise when reset

Change-Id: I6d793e2bd2c06efaf25c2cee27bc7eebee040c5c
---
 sound/soc/codecs/es8326.c | 13 ++++++++++++-
 1 file changed, 12 insertions(+), 1 deletion(-)

diff --git a/sound/soc/codecs/es8326.c b/sound/soc/codecs/es8326.c
index 7c55a4e667ad..13615d677ea6 100755
--- a/sound/soc/codecs/es8326.c
+++ b/sound/soc/codecs/es8326.c
@@ -375,6 +375,9 @@ static const struct _coeff_div coeff_div_v3[] = {
 	{3072, 8000, 24576000, 0x60, 0x02, 0x10, 0x35, 0x8A, 0x1B, 0x1F, 0x7F},
 	{3250, 8000, 26000000, 0x0C, 0x18, 0x0F, 0x2D, 0x8A, 0x0A, 0x27, 0x27},
 };
+#ifdef SPACEMIT_CONFIG_CODEC_ES8326
+static void es8326_enable_spk(struct es8326_priv *es8326, bool enable);
+#endif
 
 static inline int get_coeff(int mclk, int rate, int array,
 				const struct _coeff_div *coeff_div)
@@ -527,6 +530,10 @@ static int es8326_mute(struct snd_soc_dai *dai, int mute, int direction)
 					ES8326_MUTE_MASK, ES8326_MUTE);
 			regmap_update_bits(es8326->regmap, ES8326_HP_DRIVER_REF,
 					0x30, 0x00);
+			#ifdef SPACEMIT_CONFIG_CODEC_ES8326
+			if (!es8326->hp)
+				es8326_enable_spk(es8326, false);
+			#endif
 		} else {
 			regmap_update_bits(es8326->regmap,  ES8326_ADC_MUTE,
 					0x0F, 0x0F);
@@ -554,6 +561,10 @@ static int es8326_mute(struct snd_soc_dai *dai, int mute, int direction)
 			regmap_write(es8326->regmap, ES8326_HP_CAL, ES8326_HP_ON);
 			regmap_update_bits(es8326->regmap, ES8326_DAC_MUTE,
 					ES8326_MUTE_MASK, ~(ES8326_MUTE));
+			#ifdef SPACEMIT_CONFIG_CODEC_ES8326
+			if (!es8326->hp)
+                                es8326_enable_spk(es8326, true);
+			#endif
 		} else {
 			msleep(300);
 			regmap_update_bits(es8326->regmap,  ES8326_ADC_MUTE,
@@ -1196,7 +1207,7 @@ static int es8326_i2c_probe(struct i2c_client *i2c,
 			dev_err(&i2c->dev, "Failed to request spk_ctl_gpio\n");
 			return ret;
 		}
-		es8326_enable_spk(es8326, true);
+		es8326_enable_spk(es8326, false);
 	}
 #endif
 	es8326->mclk = devm_clk_get_optional(&i2c->dev, "mclk");
-- 
2.47.0

