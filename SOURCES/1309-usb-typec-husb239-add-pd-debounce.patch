From a86e49aa1fa3a50217a6ac135a10e6b689f913be Mon Sep 17 00:00:00 2001
From: wanlong <long.wan@spacemit.com>
Date: Tue, 26 Nov 2024 11:28:45 +0800
Subject: [PATCH 1309/1448] usb: typec: husb239: add pd debounce

Change-Id: I709648bdc6add6428016f5a7085cea0f66967ebc
---
 drivers/usb/typec/husb239.c | 68 ++++++++++++++++++++++++++++++++++---
 1 file changed, 64 insertions(+), 4 deletions(-)

diff --git a/drivers/usb/typec/husb239.c b/drivers/usb/typec/husb239.c
index 353710495747..b2b89d9da49d 100644
--- a/drivers/usb/typec/husb239.c
+++ b/drivers/usb/typec/husb239.c
@@ -442,10 +442,41 @@ static int husb239_register_partner(struct husb239 *husb239,
 	return 0;
 }
 
+static int husb239_usbpd_detect(struct husb239 *husb239)
+{
+	int ret, status, status0;
+	int count = 10;
+
+	while(--count) {
+		ret = regmap_read(husb239->regmap, HUSB239_REG_CONTRACT_STATUS0, &status0);
+		if (ret)
+			return ret;
+
+		dev_dbg(husb239->dev, "husb239 detect pd, contract status0: %x\n", status0);
+		if (((status0 & HUSB239_PD_CONTRACT_MASK) >> HUSB239_PD_CONTRACT_SHIFT) == SNKCAP_5V)
+			break;
+
+		/* check attach status */
+		ret = regmap_read(husb239->regmap, HUSB239_REG_STATUS, &status);
+		if (ret)
+			return ret;
+
+		if (!(status & HUSB239_REG_STATUS_ATTACH))
+			return -ENODEV;
+
+		msleep(50);
+	}
+
+	if (count == 0)
+		return -EINVAL;
+
+	return 0;
+}
+
 static int husb239_usbpd_request_voltage(struct husb239 *husb239)
 {
 	struct typec_info *info = &husb239->info;
-	unsigned int src_pdo;
+	unsigned int src_pdo, type, status;
 	int ret, snk_sel;
 	int count = 10;
 
@@ -486,6 +517,14 @@ static int husb239_usbpd_request_voltage(struct husb239 *husb239)
 		if (src_pdo & HUSB239_REG_SRC_DETECT)
 			break;
 
+		/* check attach status */
+		ret = regmap_read(husb239->regmap, HUSB239_REG_STATUS, &status);
+		if (ret)
+			return ret;
+
+		if (!(status & HUSB239_REG_STATUS_ATTACH))
+			return -ENODEV;
+
 		msleep(100);
 	}
 
@@ -498,7 +537,26 @@ static int husb239_usbpd_request_voltage(struct husb239 *husb239)
 	if (ret)
 		return ret;
 
-	msleep(100);
+	count = 20;
+	while(--count) {
+		ret = regmap_read(husb239->regmap, HUSB239_REG_TYPE, &type);
+		if (ret)
+			return ret;
+
+		dev_dbg(husb239->dev, "husb239_attach type: %x\n", type);
+		if (!(type & HUSB239_REG_TYPE_CC_RX_ACTIVE))
+			break;
+
+		/* check attach status */
+		ret = regmap_read(husb239->regmap, HUSB239_REG_STATUS, &status);
+		if (ret)
+			return ret;
+
+		if (!(status & HUSB239_REG_STATUS_ATTACH))
+			return -ENODEV;
+
+		msleep(100);
+	}
 
 	ret = regmap_write_bits(husb239->regmap, HUSB239_REG_GO_COMMAND,
 				HUSB239_REG_GO_COMMAND_MASK, HUSB239_REG_GO_PDO_SELECT);
@@ -558,8 +616,10 @@ static int husb239_attach(struct husb239 *husb239)
 	/* pd contract,  try max voltage */
 	if (type & HUSB239_REG_TYPE_SINK) {
 		husb239_update_operating_status(husb239);
-		husb239->req_voltage = info->sink_voltage / 1000;/* mv */
-		husb239_usbpd_request_voltage(husb239);
+		if (!husb239_usbpd_detect(husb239)) {
+			husb239->req_voltage = info->sink_voltage / 1000;/* mv */
+			husb239_usbpd_request_voltage(husb239);
+		}
 	}
 
 	return ret;
-- 
2.47.0

