From 9c14f73839e422cee80c63658c6b978075ea3425 Mon Sep 17 00:00:00 2001
From: Nell <xianbin.zhu@spacemit.com>
Date: Sat, 3 Aug 2024 14:39:43 +0800
Subject: [PATCH 0984/1451] sbi-ipi: enable the Soft-ipi early when cpu bring
 up

Change-Id: I06efeb476a60edcdf43160d55ab84287a9f63ec8
---
 arch/riscv/kernel/sbi-ipi.c | 15 +++++++++++++++
 include/linux/cpuhotplug.h  |  3 +++
 2 files changed, 18 insertions(+)

diff --git a/arch/riscv/kernel/sbi-ipi.c b/arch/riscv/kernel/sbi-ipi.c
index a4559695ce62..e03b0d6f7a85 100644
--- a/arch/riscv/kernel/sbi-ipi.c
+++ b/arch/riscv/kernel/sbi-ipi.c
@@ -12,6 +12,7 @@
 #include <linux/irqchip/chained_irq.h>
 #include <linux/irqdomain.h>
 #include <asm/sbi.h>
+#include <asm/csr.h>
 
 static int sbi_ipi_virq;
 
@@ -33,6 +34,15 @@ static int sbi_ipi_starting_cpu(unsigned int cpu)
 	return 0;
 }
 
+#ifdef CONFIG_SOC_SPACEMIT
+static int sbi_clint_ipi_starting_cpu(unsigned int cpu)
+{
+	csr_set(CSR_IE, IE_SIE);
+
+	return 0;
+}
+#endif
+
 void __init sbi_ipi_init(void)
 {
 	int virq;
@@ -71,6 +81,11 @@ void __init sbi_ipi_init(void)
 	cpuhp_setup_state(CPUHP_AP_ONLINE_DYN,
 			  "irqchip/sbi-ipi:starting",
 			  sbi_ipi_starting_cpu, NULL);
+#ifdef CONFIG_SOC_SPACEMIT
+	cpuhp_setup_state(CPUHP_AP_CLINT_IPI_RISCV_STARTING,
+			  "irqchip/sbi-clint-ipi:starting",
+			  sbi_clint_ipi_starting_cpu, NULL);
+#endif
 
 	riscv_ipi_set_virq_range(virq, BITS_PER_BYTE, false);
 	pr_info("providing IPIs using SBI IPI extension\n");
diff --git a/include/linux/cpuhotplug.h b/include/linux/cpuhotplug.h
index 624d4a38c358..af989494bb54 100644
--- a/include/linux/cpuhotplug.h
+++ b/include/linux/cpuhotplug.h
@@ -169,6 +169,9 @@ enum cpuhp_state {
 	CPUHP_AP_PERF_ARM_ACPI_STARTING,
 	CPUHP_AP_PERF_ARM_STARTING,
 	CPUHP_AP_PERF_RISCV_STARTING,
+#ifdef CONFIG_SOC_SPACEMIT
+	CPUHP_AP_CLINT_IPI_RISCV_STARTING,
+#endif
 	CPUHP_AP_ARM_L2X0_STARTING,
 	CPUHP_AP_EXYNOS4_MCT_TIMER_STARTING,
 	CPUHP_AP_ARM_ARCH_TIMER_STARTING,
-- 
2.47.0

