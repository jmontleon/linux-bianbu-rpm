From ff1d0ccdac17aa493ac3a798c72f3b0ff0b86cca Mon Sep 17 00:00:00 2001
From: zhouxl <zhouxl@spacemit.com>
Date: Fri, 15 Mar 2024 10:18:50 +0800
Subject: [PATCH 0498/1448] add compressed(gzip) kernel itb build

Change-Id: I5ad336fa1612377306d6f41b3cff6a495e3f9acf
---
 arch/riscv/Makefile      |  4 ++--
 arch/riscv/boot/Makefile | 11 +++++++----
 2 files changed, 9 insertions(+), 6 deletions(-)

diff --git a/arch/riscv/Makefile b/arch/riscv/Makefile
index 21affe9b3853..418bf0a6e93c 100644
--- a/arch/riscv/Makefile
+++ b/arch/riscv/Makefile
@@ -163,13 +163,13 @@ BOOT_TARGETS := Image Image.gz loader loader.bin xipImage vmlinuz.efi
 include $(srctree)/arch/riscv/generic/Platform
 bootvars-y	= ITS_INPUTS="$(its-y)"
 
-all:	$(notdir $(KBUILD_IMAGE)) Image.itb
+all:	$(notdir $(KBUILD_IMAGE)) Image.itb Image.gz.itb
 
 $(BOOT_TARGETS): vmlinux
 	$(Q)$(MAKE) $(build)=$(boot) $(boot)/$@
 	@$(kecho) '  Kernel: $(boot)/$@ is ready'
 
-Image.%: Image
+Image.%: Image Image.gz
 	$(Q)$(MAKE) $(build)=$(boot) $(bootvars-y) $(boot)/$@
 
 install: KBUILD_IMAGE := $(boot)/Image
diff --git a/arch/riscv/boot/Makefile b/arch/riscv/boot/Makefile
index 7e4697f6fcd4..d53f9e3b5d02 100644
--- a/arch/riscv/boot/Makefile
+++ b/arch/riscv/boot/Makefile
@@ -80,10 +80,7 @@ endif
 
 IMAGE_LOAD_ADDRESS := $(CONFIG_IMAGE_LOAD_OFFSET)
 IMAGE_ENTRY_ADDRESS := $(CONFIG_IMAGE_LOAD_OFFSET)
-
 IMAGE_ALGO := crc32
-IMAGE_COMPRESS := none
-IMAGE_SOURCE_FILE := Image
 
 quiet_cmd_its_cat = CAT     $@
       cmd_its_cat = cat $(real-prereqs) >$@
@@ -103,7 +100,10 @@ quiet_cmd_cpp_its_S = ITS     $@
 		-DADDR_CELLS=$(ADDR_CELLS)
 
 $(obj)/Image.its: $(obj)/Image.its.S $(obj)/Image FORCE
-	$(call if_changed,cpp_its_S,$(IMAGE_COMPRESS),$(IMAGE_ALGO),$(IMAGE_SOURCE_FILE))
+	$(call if_changed,cpp_its_S,none,$(IMAGE_ALGO),Image)
+
+$(obj)/Image.gz.its: $(obj)/Image.its.S $(obj)/Image.gz FORCE
+	$(call if_changed,cpp_its_S,gzip,$(IMAGE_ALGO),Image.gz)
 
 quiet_cmd_itb-image = ITB     $@
       cmd_itb-image = \
@@ -117,6 +117,9 @@ quiet_cmd_itb-image = ITB     $@
 $(obj)/Image.itb: $(obj)/Image.its $(obj)/Image FORCE
 	$(call if_changed,itb-image,$<)
 
+$(obj)/Image.%.itb: $(obj)/Image.%.its $(obj)/Image.% FORCE
+	$(call if_changed,itb-image,$<)
+
 EFI_ZBOOT_PAYLOAD	:= Image
 EFI_ZBOOT_BFD_TARGET	:= elf$(BITS)-littleriscv
 EFI_ZBOOT_MACH_TYPE	:= RISCV$(BITS)
-- 
2.47.0

