From 75d9d146c1f21a63708d6d3768d9060f12568f48 Mon Sep 17 00:00:00 2001
From: yanhaodong <haodong.yan@spacemit.com>
Date: Tue, 10 Dec 2024 09:01:59 +0800
Subject: [PATCH 1335/1448] i2c: spacemit/k1: update i2c function while reboot

Change-Id: I1b85456747c8a922720797cf0f48cbd72a921b67
---
 drivers/i2c/busses/i2c-k1x.c | 27 +++++++++++++++++++++------
 1 file changed, 21 insertions(+), 6 deletions(-)

diff --git a/drivers/i2c/busses/i2c-k1x.c b/drivers/i2c/busses/i2c-k1x.c
index f2b695044072..fdf9ea536f87 100644
--- a/drivers/i2c/busses/i2c-k1x.c
+++ b/drivers/i2c/busses/i2c-k1x.c
@@ -1131,8 +1131,9 @@ static void spacemit_i2c_init_xfer_params(struct spacemit_i2c_dev *spacemit_i2c)
 static int spacemit_i2c_pio_xfer(struct spacemit_i2c_dev *spacemit_i2c)
 {
 	int ret = 0, xfer_try = 0;
-	u32 status;
+	u32 status, ctrl;
 	signed long timeout;
+	signed long stop_timeout = 3000;
 
 xfer_retry:
 	/* calculate timeout */
@@ -1163,7 +1164,17 @@ static int spacemit_i2c_pio_xfer(struct spacemit_i2c_dev *spacemit_i2c)
 	}
 
 	while (spacemit_i2c->num > 0 && timeout > 0) {
-		status = spacemit_i2c_read_reg(spacemit_i2c, REG_SR);
+		ctrl = spacemit_i2c_read_reg(spacemit_i2c, REG_CR);
+		if (ctrl & CR_STOP)
+			while (stop_timeout > 0) {
+				status = spacemit_i2c_read_reg(spacemit_i2c, REG_SR);
+				udelay(100);
+				stop_timeout -= 100;
+				if (status & SR_MSD)
+					break;
+			}
+		else 
+			status = spacemit_i2c_read_reg(spacemit_i2c, REG_SR);
 		spacemit_i2c_clear_int_status(spacemit_i2c, status);
 		spacemit_i2c->i2c_status = status;
 
@@ -1183,13 +1194,17 @@ static int spacemit_i2c_pio_xfer(struct spacemit_i2c_dev *spacemit_i2c)
 
 		/* transmit empty */
 		if (likely(status & SR_ITE)) {
-			ret = spacemit_i2c_byte_xfer(spacemit_i2c);
-			if (unlikely(ret < 0))
+			if ((spacemit_i2c->tx_cnt > 1) && (status & SR_MSD))
 				break;
+			else {
+				ret = spacemit_i2c_byte_xfer(spacemit_i2c);
+				if (unlikely(ret < 0))
+					break;
+			}
 		}
-
+		
 		/* transaction done */
-		if (likely(status & SR_MSD))
+		if (((status & SR_MSD) && !(status & SR_ITE)))
 			break;
 
 		udelay(10);
-- 
2.47.0

