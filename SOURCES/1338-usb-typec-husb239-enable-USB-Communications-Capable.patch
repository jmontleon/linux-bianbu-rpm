From f2f61d95f5277d815a71d54a922ea2b93cb79005 Mon Sep 17 00:00:00 2001
From: wanlong <long.wan@spacemit.com>
Date: Tue, 10 Dec 2024 14:25:17 +0800
Subject: [PATCH 1338/1448] usb: typec: husb239: enable USB Communications
 Capable

Change-Id: Ib9708db3489cb0112d074e4dd8395ac49f9dda87
---
 drivers/usb/typec/husb239.c | 31 +++++++++++++++++++++++++++++--
 1 file changed, 29 insertions(+), 2 deletions(-)

diff --git a/drivers/usb/typec/husb239.c b/drivers/usb/typec/husb239.c
index b2b89d9da49d..0df0efbc991e 100644
--- a/drivers/usb/typec/husb239.c
+++ b/drivers/usb/typec/husb239.c
@@ -51,7 +51,7 @@
 #define HUSB239_REG_SRC_PDO_9V		0x6B
 #define HUSB239_REG_SRC_PDO_12V		0x6C
 
-#define HUSB239_REG_MAX				0x97
+#define HUSB239_REG_MAX				0xFF
 
 #define HUSB239_REG_PORTROLE_ORIENTDEB			BIT(6)
 #define HUSB239_REG_PORTROLE_MASK				GENMASK(5, 4)
@@ -697,7 +697,7 @@ static int husb23_usb_set_orientation(struct typec_switch_dev *sw,
 
 static int husb239_chip_init(struct husb239 *husb239)
 {
-	int ret;
+	int ret, value;
 
 	husb239->vdd_supply = devm_regulator_get_optional(husb239->dev, "vdd");
 	if (IS_ERR(husb239->vdd_supply)) {
@@ -745,6 +745,33 @@ static int husb239_chip_init(struct husb239 *husb239)
 	if (ret)
 		return ret;
 
+	/*  enable USB Communications Capable
+	 *  0xb8 =0x25; 0xcb =0x37; 0xdf= 0x48; 0x1f=0x33;
+	 *  0x4a[3]=1b; 0x1f= 0x00;
+	 */
+	ret = regmap_write(husb239->regmap, 0xB8, 0x25)
+			| regmap_write(husb239->regmap, 0xCB, 0x37)
+			| regmap_write(husb239->regmap, 0xDF, 0x48)
+			| regmap_write(husb239->regmap, 0x1F, 0x33);
+	if (ret){
+		return ret;
+	}
+
+	ret = regmap_read(husb239->regmap, 0x4A, &value);
+	if (ret){
+		return ret;
+	}
+
+	ret = regmap_write(husb239->regmap, 0x4A, value | 0x8);
+	if (ret){
+		return ret;
+	}
+
+	ret = regmap_write(husb239->regmap, 0x1F, 0x00);
+	if (ret){
+		return ret;
+	}
+
 	ret = regmap_write(husb239->regmap, HUSB239_REG_CONTROL1,
 				HUSB239_REG_CONTROL1_VDM_RESPOND |
 				HUSB239_REG_CONTROL1_I2C_ENABLE |
-- 
2.47.0

